# OpenFront.io Attack Ratio Architecture

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OpenFront.io Game                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  UserSettings    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  localStorage   â”‚              â”‚
â”‚  â”‚   Modal          â”‚  save   â”‚  .attackRatio   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚                            â”‚                        â”‚
â”‚           â”‚ set                        â”‚ load                   â”‚
â”‚           â–¼                            â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚          ControlPanel Component              â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚  â”‚  Attack Ratio Slider (DOM)             â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  <input id="attack-ratio"              â”‚  â”‚              â”‚
â”‚  â”‚  â”‚         type="range"                   â”‚  â”‚              â”‚
â”‚  â”‚  â”‚         min="1" max="100">             â”‚  â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â”‚  â”‚                     â”‚                         â”‚              â”‚
â”‚  â”‚                     â”‚ @input                  â”‚              â”‚
â”‚  â”‚                     â–¼                         â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚  â”‚  this.attackRatio (component state)    â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  - Decimal value (0.0 - 1.0)           â”‚  â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â”‚  â”‚                     â”‚                         â”‚              â”‚
â”‚  â”‚                     â”‚ onAttackRatioChange()   â”‚              â”‚
â”‚  â”‚                     â–¼                         â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚  â”‚  UIState.attackRatio (shared state)    â”‚â—€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â”‚  - Global game state                   â”‚  â”‚         â”‚    â”‚
â”‚  â”‚  â”‚  - Shared across all components        â”‚  â”‚         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚                          â”‚                                 â”‚    â”‚
â”‚                          â”‚ read                            â”‚    â”‚
â”‚                          â–¼                                 â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  PlayerActionHandler                        â”‚          â”‚    â”‚
â”‚  â”‚  - Uses uiState.attackRatio                 â”‚          â”‚    â”‚
â”‚  â”‚  - Calculates troops to send                â”‚          â”‚    â”‚
â”‚  â”‚  - Triggers attacks                         â”‚          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚    â”‚
â”‚                                                            â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  EventsDisplay                              â”‚          â”‚    â”‚
â”‚  â”‚  - Uses uiState.attackRatio                 â”‚          â”‚    â”‚
â”‚  â”‚  - Handles retaliation attacks              â”‚          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚    â”‚
â”‚                                                            â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  SendResourceModal                          â”‚          â”‚    â”‚
â”‚  â”‚  - Uses uiState.attackRatio                 â”‚          â”‚    â”‚
â”‚  â”‚  - Pre-fills troop donation slider          â”‚          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚    â”‚
â”‚                                                            â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
â”‚                    OTS Userscript                          â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚                                                            â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  GameAPI.getAttackRatio()                   â”‚          â”‚    â”‚
â”‚  â”‚                                             â”‚          â”‚    â”‚
â”‚  â”‚  Priority access methods:                  â”‚          â”‚    â”‚
â”‚  â”‚  1. ControlPanel.uiState.attackRatio â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”‚     âœ… BEST - Live game state              â”‚               â”‚
â”‚  â”‚                                             â”‚               â”‚
â”‚  â”‚  2. DOM #attack-ratio input.value          â”‚               â”‚
â”‚  â”‚     âš ï¸ BACKUP - Current UI value           â”‚               â”‚
â”‚  â”‚                                             â”‚               â”‚
â”‚  â”‚  3. localStorage.settings.attackRatio      â”‚               â”‚
â”‚  â”‚     ğŸ”„ FALLBACK - Saved setting            â”‚               â”‚
â”‚  â”‚                                             â”‚               â”‚
â”‚  â”‚  4. Default: 0.2 (20%)                     â”‚               â”‚
â”‚  â”‚     ğŸ›¡ï¸ SAFETY - Last resort                â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                          â”‚                                     â”‚
â”‚                          â”‚ read every 100ms                    â”‚
â”‚                          â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  TroopMonitor                               â”‚              â”‚
â”‚  â”‚  - Detects changes in attack ratio          â”‚              â”‚
â”‚  â”‚  - Sends TROOP_UPDATE event via WebSocket   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                                     â”‚
â”‚                          â”‚ ws.send()                           â”‚
â”‚                          â–¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ WebSocket
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OTS Server & Dashboard                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  TroopsModule.vue                           â”‚              â”‚
â”‚  â”‚  - Displays current/max troops              â”‚              â”‚
â”‚  â”‚  - Shows attack ratio slider (read-only)    â”‚              â”‚
â”‚  â”‚  - LCD-style display simulation             â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                                     â”‚
â”‚                          â”‚ set-attack-ratio command            â”‚
â”‚                          â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  OpenFrontBridge (userscript)               â”‚              â”‚
â”‚  â”‚  - Updates DOM #attack-ratio input          â”‚              â”‚
â”‚  â”‚  - Dispatches input + change events         â”‚              â”‚
â”‚  â”‚  - Triggers game's onAttackRatioChange()    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Access Method Comparison

| Method | Location | Format | Pros | Cons | Use Case |
|--------|----------|--------|------|------|----------|
| **UIState** | `controlPanel.uiState.attackRatio` | `number` (0.0-1.0) | âœ… Real-time<br>âœ… Official API<br>âœ… Type-safe | âš ï¸ Requires control panel rendered | **Primary** - Live gameplay |
| **DOM Input** | `#attack-ratio.value` | `string` (1-100) | âœ… Always visible<br>âœ… UI-accurate | âŒ DOM-dependent<br>âŒ Parsing needed | **Backup** - UI fallback |
| **localStorage** | `settings.attackRatio` | `string` (0.0-1.0) | âœ… Persistent<br>âœ… Always available | âŒ Not real-time<br>âŒ Saved value only | **Fallback** - Settings |
| **Default** | Hard-coded | `number` (0.2) | âœ… Always works | âŒ May be incorrect | **Safety** - Last resort |

## Component Relationships

```
UserSettings â”€â”€(save)â”€â”€> localStorage
     â”‚                        â”‚
     â”‚                        â”‚
     â””â”€â”€(set)â”€â”€â”         (load)
               â–¼           â”‚
         ControlPanel â—€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€â”€(manages)â”€â”€> DOM Input
               â”‚
               â””â”€â”€(updates)â”€â”€> UIState â”€â”€(read by)â”€â”€> All Game Components
                                  â–²
                                  â”‚
                          (accessed by)
                                  â”‚
                             GameAPI (userscript)
```

## Update Flow

### Player Changes Attack Ratio in Game

```
1. Player drags slider or presses T/Y keys
   â””â”€â–¶ ControlPanel receives input event
       â””â”€â–¶ Updates this.attackRatio (component state)
           â””â”€â–¶ Calls onAttackRatioChange()
               â””â”€â–¶ Updates uiState.attackRatio (shared state)
                   â””â”€â–¶ GameAPI.getAttackRatio() reads new value
                       â””â”€â–¶ TroopMonitor detects change
                           â””â”€â–¶ Sends TROOP_UPDATE to server
                               â””â”€â–¶ Dashboard updates display
```

### Dashboard Changes Attack Ratio via WebSocket

```
1. User adjusts slider in TroopsModule.vue
   â””â”€â–¶ Sends set-attack-ratio command via WebSocket
       â””â”€â–¶ OpenFrontBridge.handleSetAttackRatio()
           â””â”€â–¶ Updates DOM input#attack-ratio.value
               â””â”€â–¶ Dispatches 'input' event
                   â””â”€â–¶ ControlPanel receives event
                       â””â”€â–¶ Updates attackRatio state
                           â””â”€â–¶ Updates uiState.attackRatio
                               â””â”€â–¶ Game uses new ratio for attacks
```

## Keyboard Shortcuts

The game supports keyboard shortcuts for quick ratio adjustment:

- **T key**: Decrease ratio by 10% (e.g., 50% â†’ 40%)
- **Y key**: Increase ratio by 10% (e.g., 50% â†’ 60%)

These shortcuts fire an `AttackRatioEvent` that updates the ControlPanel state and UIState.

## Source Code References

- **UIState Interface**: `src/client/graphics/UIState.ts`
- **ControlPanel**: `src/client/graphics/layers/ControlPanel.ts` (lines 42-237)
- **UserSettings**: `src/client/UserSettingModal.ts` (lines 172-197, 358-385)
- **Input Handler**: `src/client/InputHandler.ts` (lines 367-399)
- **PlayerActionHandler**: `src/client/graphics/layers/PlayerActionHandler.ts` (lines 20-56)
- **EventsDisplay**: `src/client/graphics/layers/EventsDisplay.ts` (lines 760-773)

Repository: https://github.com/openfrontio/OpenFrontIO/
